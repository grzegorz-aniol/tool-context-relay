#!/usr/bin/env sh
set -eu

#
# Model aliases (OpenAI-compatible servers often require long model identifiers).
# Add your own aliases here.
#
MODEL_BIELIK="Bielik-11B-v3.0-Instruct.f16.gguf"

usage() {
  cat <<'EOF'
Usage:
  ./run-case [tool-context-relay options...] <case-id>

Examples:
  ./run-case case1
  ./run-case --profile bielik --model BIELIK case1
  ./run-case --profile openai --model gpt-4.1-mini case2

Notes:
  - <case-id> should be "case1".."caseN" (numeric ids like "1" are also accepted).
  - `--model` also accepts aliases defined in this file (e.g. BIELIK).
  - Use `--profile` to point the CLI at a different profile (defaults to openai).
EOF
}

if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ] || [ "${1:-}" = "help" ]; then
  usage
  exit 0
fi

if [ $# -lt 1 ]; then
  usage >&2
  exit 2
fi

script_dir="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)"
repo_root="$script_dir"
cd "$repo_root"

# The wrapper mirrors the CLI shape: flags first, "prompt" (case) last.
case_id=""
for arg in "$@"; do
  case_id="$arg"
done

case_id="${case_id#./}"
case_id="${case_id#case}"
case_id="case${case_id}"

case_file_md="${repo_root}/prompt_cases/${case_id}.md"
case_file_txt="${repo_root}/prompt_cases/${case_id}.txt"
case_file=""
if [ -f "$case_file_md" ]; then
  case_file="$case_file_md"
elif [ -f "$case_file_txt" ]; then
  case_file="$case_file_txt"
else
  echo "Unknown case-id: ${case_id}. Expected e.g. 'case1' (file: ${case_file_md})." >&2
  exit 2
fi

quote_sh() {
  printf "'%s'" "$(printf "%s" "$1" | sed "s/'/'\\\\''/g")"
}

expanded_argv=""
profile_provided="0"

# Parse tool-context-relay options (everything except the last arg, which is <case-id>).
while [ $# -gt 1 ]; do
  case "$1" in
    --profile)
      profile_value="${2:-}"
      if [ -z "$profile_value" ]; then
        echo "Missing value for --profile." >&2
        exit 2
      fi
      expanded_argv="${expanded_argv} $(quote_sh --profile) $(quote_sh "$profile_value")"
      profile_provided="1"
      shift 2
      ;;
    --profile=*)
      expanded_argv="${expanded_argv} $(quote_sh "$1")"
      profile_provided="1"
      shift 1
      ;;
    --model)
      model_value="${2:-}"
      if [ -z "$model_value" ]; then
        echo "Missing value for --model." >&2
        exit 2
      fi
      case "$model_value" in
        BIELIK) model_value="$MODEL_BIELIK" ;;
      esac
      expanded_argv="${expanded_argv} $(quote_sh --model) $(quote_sh "$model_value")"
      shift 2
      ;;
    --model=*)
      model_value="${1#--model=}"
      case "$model_value" in
        BIELIK) model_value="$MODEL_BIELIK" ;;
      esac
      expanded_argv="${expanded_argv} $(quote_sh "--model=$model_value")"
      shift 1
      ;;
    *)
      expanded_argv="${expanded_argv} $(quote_sh "$1")"
      shift 1
      ;;
  esac
done

expanded_argv="${expanded_argv} $(quote_sh --file) $(quote_sh "$case_file")"

eval "set -- ${expanded_argv# }"
exec uv run tool-context-relay "$@"
